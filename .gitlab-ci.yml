stages:
  - build
  - coverage

.build_template: &gcc_build_definition
  stage: build
  cache:
    paths:
      - subprojects/
  script:
    - meson build
    - ninja -C build test

.build_template: &clang_build_definition
  stage: build
  cache:
    paths:
      - subprojects/
  script:
    - CC=clang CXX=clang++ meson build
    - ninja -C build test

build:debian-gcc:
  image: registry.gitlab.com/dreyri/matter/debian:v4
  <<: *gcc_build_definition

build:debian-clang:
  image: registry.gitlab.com/dreyri/matter/debian:v4
  <<: *clang_build_definition

build:alpine:
  image: registry.gitlab.com/dreyri/matter/alpine:v1
  <<: *gcc_build_definition

coverage:
  image: registry.gitlab.com/dreyri/matter/debian:v4
  stage: coverage
  script:
    - meson -Db_coverage=true build
    - ninja -C build test
    - ninja -C build coverage-text
  artifacts:
    paths:
      - build/meson-logs/coverage.txt
